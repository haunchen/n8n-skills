name: Update n8n Skill Pack

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger
    inputs:
      version-bump:
        description: 'Version bump type'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update n8n to latest
        id: update_n8n
        run: |
          # 記錄更新前的版本
          OLD_N8N=$(jq -r '.dependencies["n8n"]' package.json | sed 's/\^//')

          # 更新 n8n 主套件到最新版本
          npm install n8n@latest

          # 記錄更新後的版本
          NEW_N8N=$(jq -r '.dependencies["n8n"]' package.json | sed 's/\^//')

          echo "old_version=$OLD_N8N" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_N8N" >> $GITHUB_OUTPUT

          if [ "$OLD_N8N" != "$NEW_N8N" ]; then
            echo "n8n_updated=true" >> $GITHUB_OUTPUT
            echo "n8n updated: v$OLD_N8N → v$NEW_N8N"
          else
            echo "n8n_updated=false" >> $GITHUB_OUTPUT
            echo "n8n is already up to date: v$NEW_N8N"
          fi

      - name: Update other n8n packages if n8n was updated
        if: steps.update_n8n.outputs.n8n_updated == 'true'
        run: |
          echo "n8n was updated, updating related packages..."
          npm install n8n-core@latest n8n-workflow@latest n8n-nodes-base@latest @n8n/n8n-nodes-langchain@latest

      - name: Check n8n packages version changes
        id: check_version
        run: |
          # Read old versions (from main branch)
          git fetch origin main
          OLD_N8N=$(git show origin/main:package.json | jq -r '.dependencies["n8n"]' | sed 's/\^//')
          OLD_N8N_CORE=$(git show origin/main:package.json | jq -r '.dependencies["n8n-core"]' | sed 's/\^//')
          OLD_N8N_NODES_BASE=$(git show origin/main:package.json | jq -r '.dependencies["n8n-nodes-base"]' | sed 's/\^//')
          OLD_N8N_LANGCHAIN=$(git show origin/main:package.json | jq -r '.dependencies["@n8n/n8n-nodes-langchain"]' | sed 's/\^//')

          # Read new versions (after update)
          NEW_N8N=$(jq -r '.dependencies["n8n"]' package.json | sed 's/\^//')
          NEW_N8N_CORE=$(jq -r '.dependencies["n8n-core"]' package.json | sed 's/\^//')
          NEW_N8N_NODES_BASE=$(jq -r '.dependencies["n8n-nodes-base"]' package.json | sed 's/\^//')
          NEW_N8N_LANGCHAIN=$(jq -r '.dependencies["@n8n/n8n-nodes-langchain"]' package.json | sed 's/\^//')

          echo "old_n8n_version=$OLD_N8N" >> $GITHUB_OUTPUT
          echo "new_n8n_version=$NEW_N8N" >> $GITHUB_OUTPUT

          # Check if any n8n package has changed
          VERSION_CHANGED=false
          N8N_CHANGED=false

          if [ "$OLD_N8N" != "$NEW_N8N" ]; then
            VERSION_CHANGED=true
            N8N_CHANGED=true
            echo "n8n version changed: v$OLD_N8N → v$NEW_N8N"
          fi

          if [ "$OLD_N8N_CORE" != "$NEW_N8N_CORE" ]; then
            VERSION_CHANGED=true
            echo "n8n-core version changed: v$OLD_N8N_CORE → v$NEW_N8N_CORE"
          fi

          if [ "$OLD_N8N_NODES_BASE" != "$NEW_N8N_NODES_BASE" ]; then
            VERSION_CHANGED=true
            echo "n8n-nodes-base version changed: v$OLD_N8N_NODES_BASE → v$NEW_N8N_NODES_BASE"
          fi

          if [ "$OLD_N8N_LANGCHAIN" != "$NEW_N8N_LANGCHAIN" ]; then
            VERSION_CHANGED=true
            echo "@n8n/n8n-nodes-langchain version changed: v$OLD_N8N_LANGCHAIN → v$NEW_N8N_LANGCHAIN"
          fi

          echo "version_changed=$VERSION_CHANGED" >> $GITHUB_OUTPUT
          echo "n8n_changed=$N8N_CHANGED" >> $GITHUB_OUTPUT

          if [ "$VERSION_CHANGED" = false ]; then
            echo "No n8n package version changes detected, skipping build"
          fi

      - name: Check if should update community packages
        id: check_community
        run: |
          # Update community packages on the first Sunday of each month (day 1-7)
          DAY_OF_MONTH=$(date +%d)
          if [ "$DAY_OF_MONTH" -le 7 ]; then
            echo "should_update=true" >> $GITHUB_OUTPUT
            echo "First Sunday of the month, will update community packages"
          else
            echo "should_update=false" >> $GITHUB_OUTPUT
            echo "Not the first Sunday of the month, skipping community packages update"
          fi

      - name: Update community packages
        if: steps.check_community.outputs.should_update == 'true'
        id: update_community
        run: |
          echo "Updating community packages from npm..."
          npm run update:community

          # Check if community packages changed
          if [[ -n $(git diff config/community-packages.json) ]]; then
            echo "community_updated=true" >> $GITHUB_OUTPUT
            echo "Community packages updated"
          else
            echo "community_updated=false" >> $GITHUB_OUTPUT
            echo "No community packages changes"
          fi

      - name: Determine if build is needed
        id: need_build
        run: |
          VERSION_CHANGED="${{ steps.check_version.outputs.version_changed }}"
          COMMUNITY_UPDATED="${{ steps.update_community.outputs.community_updated }}"

          if [ "$VERSION_CHANGED" == "true" ] || [ "$COMMUNITY_UPDATED" == "true" ]; then
            echo "need_build=true" >> $GITHUB_OUTPUT
            echo "Build needed: n8n_changed=$VERSION_CHANGED, community_updated=$COMMUNITY_UPDATED"
          else
            echo "need_build=false" >> $GITHUB_OUTPUT
            echo "No build needed"
          fi

      - name: Run full build
        if: steps.need_build.outputs.need_build == 'true'
        run: npm run build:full

      - name: Validate output files
        if: steps.need_build.outputs.need_build == 'true'
        run: npm run validate

      - name: Update website data
        if: steps.need_build.outputs.need_build == 'true'
        run: npm run update:website

      - name: Determine version bump type
        if: steps.need_build.outputs.need_build == 'true'
        id: determine_bump
        run: |
          MANUAL_BUMP="${{ github.event.inputs.version-bump }}"
          N8N_CHANGED="${{ steps.check_version.outputs.n8n_changed }}"
          COMMUNITY_UPDATED="${{ steps.update_community.outputs.community_updated }}"

          if [ "$MANUAL_BUMP" != "" ] && [ "$MANUAL_BUMP" != "auto" ]; then
            # Manual trigger with specified version type
            echo "bump_type=$MANUAL_BUMP" >> $GITHUB_OUTPUT
            echo "Using manually specified version type: $MANUAL_BUMP"
          elif [ "$N8N_CHANGED" == "true" ]; then
            # Analyze n8n version change to determine bump type
            OLD_N8N="${{ steps.check_version.outputs.old_n8n_version }}"
            NEW_N8N="${{ steps.check_version.outputs.new_n8n_version }}"

            # Parse version numbers (major.minor.patch)
            IFS='.' read -r OLD_MAJOR OLD_MINOR OLD_PATCH <<< "$OLD_N8N"
            IFS='.' read -r NEW_MAJOR NEW_MINOR NEW_PATCH <<< "$NEW_N8N"

            # Determine bump type based on n8n version change
            if [ "$NEW_MAJOR" != "$OLD_MAJOR" ]; then
              echo "bump_type=major" >> $GITHUB_OUTPUT
              echo "n8n major upgrade detected: v$OLD_N8N → v$NEW_N8N, using major version bump"
            elif [ "$NEW_MINOR" != "$OLD_MINOR" ]; then
              echo "bump_type=minor" >> $GITHUB_OUTPUT
              echo "n8n minor upgrade detected: v$OLD_N8N → v$NEW_N8N, using minor version bump"
            elif [ "$NEW_PATCH" != "$OLD_PATCH" ]; then
              echo "bump_type=patch" >> $GITHUB_OUTPUT
              echo "n8n patch upgrade detected: v$OLD_N8N → v$NEW_N8N, using patch version bump"
            else
              echo "bump_type=patch" >> $GITHUB_OUTPUT
              echo "n8n version unchanged: v$NEW_N8N, using patch version bump"
            fi
          elif [ "$COMMUNITY_UPDATED" == "true" ]; then
            # Only community packages updated, use patch
            echo "bump_type=patch" >> $GITHUB_OUTPUT
            echo "Community packages updated, using patch version bump"
          else
            # Only other n8n packages changed, use patch
            echo "bump_type=patch" >> $GITHUB_OUTPUT
            echo "Other n8n packages updated (n8n-core/n8n-nodes-base/n8n-nodes-langchain), using patch version bump"
          fi

      - name: Update package.json version
        if: steps.need_build.outputs.need_build == 'true'
        id: bump_version
        run: |
          CURRENT_VERSION=$(jq -r '.version' package.json)
          BUMP_TYPE="${{ steps.determine_bump.outputs.bump_type }}"

          # Parse version number
          IFS='.' read -r -a version_parts <<< "$CURRENT_VERSION"
          MAJOR="${version_parts[0]}"
          MINOR="${version_parts[1]}"
          PATCH="${version_parts[2]}"

          # Bump version by type
          case "$BUMP_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"

          # Update package.json
          jq --arg version "$NEW_VERSION" '.version = $version' package.json > package.json.tmp
          mv package.json.tmp package.json

          echo "old_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Version updated: $CURRENT_VERSION → $NEW_VERSION"

      - name: Update README.md version statement
        if: steps.check_version.outputs.n8n_changed == 'true'
        run: |
          N8N_VERSION="${{ steps.check_version.outputs.new_n8n_version }}"
          sed -i "s/支援 n8n 版本：v[0-9.]\+/支援 n8n 版本：v${N8N_VERSION}/" README.md
          echo "README.md updated with n8n version v${N8N_VERSION}"

      - name: Check for changes
        if: steps.need_build.outputs.need_build == 'true'
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Get change summary
        if: steps.check_changes.outputs.has_changes == 'true'
        id: get_summary
        run: |
          CHANGED_FILES=$(git diff --name-only | head -20)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate PR title
        if: steps.need_build.outputs.need_build == 'true'
        id: pr_title
        run: |
          OLD_N8N="${{ steps.check_version.outputs.old_n8n_version }}"
          NEW_N8N="${{ steps.check_version.outputs.new_n8n_version }}"
          N8N_CHANGED="${{ steps.check_version.outputs.n8n_changed }}"
          COMMUNITY_UPDATED="${{ steps.update_community.outputs.community_updated }}"

          if [ "$N8N_CHANGED" == "true" ]; then
            PR_TITLE="Auto update: n8n v${OLD_N8N} → v${NEW_N8N}"
          elif [ "$COMMUNITY_UPDATED" == "true" ]; then
            PR_TITLE="Auto update: community packages refresh"
          else
            PR_TITLE="Auto update: n8n v${NEW_N8N} data refresh"
          fi

          echo "title=$PR_TITLE" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_PAT }}
          commit-message: |
            Update n8n skill pack data and website

            Automatically update n8n node data, documentation, and website information

            - n8n version: v${{ steps.check_version.outputs.new_n8n_version }}
            - Skill pack version: ${{ steps.bump_version.outputs.old_version }} → ${{ steps.bump_version.outputs.new_version }}
            - Community packages: ${{ steps.update_community.outputs.community_updated == 'true' && 'updated' || 'unchanged' }}
            - Website data synchronized

            Changed files:
            ${{ steps.get_summary.outputs.changed_files }}
          branch: auto-update-skill-pack
          delete-branch: true
          title: ${{ steps.pr_title.outputs.title }}
          body: |
            ## Auto Update n8n Skill Pack

            This PR is automatically created by GitHub Actions with the latest n8n node data.

            ### Version Information

            - n8n version: v${{ steps.check_version.outputs.new_n8n_version }}
            - Skill pack version: ${{ steps.bump_version.outputs.old_version }} → ${{ steps.bump_version.outputs.new_version }}
            - Version bump type: ${{ steps.determine_bump.outputs.bump_type }}
            - Community packages updated: ${{ steps.update_community.outputs.community_updated == 'true' && 'Yes' || 'No' }}

            ### Updates

            The following data has been automatically synchronized:
            - Node count updated
            - n8n version number updated
            - Template count updated
            - Community packages (top 30 from npm, monthly)
            - Last update date refreshed

            ### Changes

            ```
            ${{ steps.get_summary.outputs.changed_files }}
            ```

            ### Checklist

            - [ ] Check data integrity
            - [ ] Verify Markdown format
            - [ ] Confirm internal links work
            - [ ] Test skill pack loading
            - [ ] Verify version number
          labels: |
            auto-update
            dependencies

      - name: Update result notification
        if: always()
        run: |
          NEED_BUILD="${{ steps.need_build.outputs.need_build }}"
          HAS_CHANGES="${{ steps.check_changes.outputs.has_changes }}"
          VERSION_CHANGED="${{ steps.check_version.outputs.version_changed }}"
          COMMUNITY_UPDATED="${{ steps.update_community.outputs.community_updated }}"

          echo "=== Update Summary ==="
          echo "n8n packages changed: $VERSION_CHANGED"
          echo "Community packages updated: $COMMUNITY_UPDATED"
          echo "Build needed: $NEED_BUILD"
          echo "Has changes: $HAS_CHANGES"

          if [[ "$NEED_BUILD" == "false" ]]; then
            echo "No updates needed"
          elif [[ "$HAS_CHANGES" == "true" ]]; then
            echo "Pull Request created, awaiting review"
          else
            echo "Build ran but no file changes detected"
          fi
